---
title: 'Math E-23c: R Final Project'
author: "Rachel Lee"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=15, fig.height=7, fig.align = "center")
```

### About the dataset
I looked at employee earnings in the City of Boston in the most recent year the data was available, 2017. The cleaned dataset contains twelve columns, giving employee names and various details about their employment and earnings with the city, and 22,245 rows, corresponding to the same number of people who received compensations from the City in 2017.

Two categorical columns (excluding “Name” as a variable) give the employee’s department and title under which the compensation was received. Eight numerical columns detail the nature of this compensation, including “Regular,” or base salaries and “Total” compensations. I engineered an additional categorical column indicating employees' genders.

Further descriptions of both the original and cleaned datasets may be found in the attached handout.


### Relationship between regular and total earnings
Let's first take a look at columns for "Regular" earnings, or base salary amount, and "Total," or this base salary plus additional compensations via overtime, injured, incentives, etc.

```{r echo = FALSE, warning=FALSE}
library(ggplot2)
library(reshape2)
boston <- read.csv("boston.csv", na.strings = '')
regular <- boston$REGULAR
total <- boston$TOTAL


plot(regular, total, pch = ".", cex = 2, col="darkolivegreen3",
     main = paste("City of Boston employees: total vs. regular earnings"),
     xlab = "Regular earnings",
     ylab = "Total earnings")
```

The correlation between overall regular and total compensation is `r round(cor(total, regular), 2)`.

It makes intuitive sense that total and regular compensation amounts have a fairly high positive correlation; a high base salary generally indicates high total earnings, and vice versa.

Since regular earnings cannot exceed total earnings, there is a visible boundary on the scatterplot where regular earnings = total earnings.

No points fall below this line. All points above the line indicate employees who recieve earnings outside of their regular base salary.


```{r echo=FALSE}

plot(regular, total, pch = ".", cex = 2, col="darkolivegreen3",
     main = paste("City of Boston employees: total vs. regular earnings"),
     xlab = "Regular earnings",
     ylab = "Total earnings")

abline(a = 0, b = 1, col="red", lty = 2, lwd=2)

boston.lm <- lm(total~regular, data = boston)

abline(boston.lm, col="red", lty = 1, lwd=2)

```

The dashed line indicates the regular = total boundary, while the solid line indicates the best fit regression line generated by R.

Our R-squared value is about .76, indicating that this regression line is fairly well-fitted to the data.

The formula for our regression line is total = 1.17*(regular) + 1643. The fact that our slope is greater than 1 indicates that employees with higher base salaries are generally more likely to receive compensations in addition to that base salary, than are employees with lower base salaries.


``` {r echo=TRUE}
summary(regular)
```
Regular compensation amounts range from \$0 to about \$266k, with an average value of about \$60k.

``` {r echo=TRUE}
summary(total)
```

Total compensation amounts range from \$3.50 to about \$366k, with an average value of about \$71k.



``` {r echo=FALSE}
ggplot(data=boston, aes(boston$REGULAR)) +
  geom_histogram(breaks=seq(0, max(boston$REGULAR), by = 5000),
                 col = "gold4", fill = "gold") +
  labs(title = "City of Boston employee compensation: base salaries") +
  labs(x="Base salaries", y="Count") + theme_minimal()

ggplot(data=boston, aes(boston$TOTAL)) +
  geom_histogram(breaks=seq(0, max(total), by = 5000),
                 col = "darkolivegreen", fill = "darkolivegreen3") +
  labs(title = "City of Boston employee compensation: total earnings") +
  labs(x="Total earnings", y="Count") + theme_minimal()


```

The histograms for both total and regular earnings look somewhat odd, though they follow the same general pattern. Either one could be rooted in an exponential distribution, but both have notable spikes around \$0, \$50k, and \$100k.


``` {r echo=FALSE}
lambda <- 1/mean(total)
hist(total, probability=TRUE, breaks=60,
     col = "darkolivegreen3", border = "darkolivegreen",
     main = paste("City of Boston employee compensation: total earnings"),
     xlab = "Total earnings",
     ylab = "Count")
curve(dexp(x, lambda), add=TRUE, lwd=2)

```

The histogram of total earnings more closely resembled an exponential distribution, so I overlaid the predicted curve by calculating a value of lambda from the data.

Parts of the graph follow the exponential curve fairly well, but it's visibly clear that the spike of counts around \$100k far exceeds the curve. Dividing the observed data into ten bins and running a chi-square test of uniformity against the expected counts in the exponential density curve results in an infinitesimal p-value, confirming that the exponential curve is a poor fit for the entire set of total earnings data.


### Analysis by department
#### Eight most populated departments

The original dataset contains 227 different "departments," ranging in population from 1 to 3149 employees. For simplicity's sake and for ease of visualization, I looked at a few selections of the most heavily populated departments. The City's eight departments with the highest employee counts are as follows:

``` {r echo=FALSE, warning=FALSE}
deptTbl <- table(boston$DEPT)
deptTbl <- sort(deptTbl, decreasing=TRUE); head(deptTbl, 8)

```

And a stacked barplot of these eight departments by gender:

``` {r echo=FALSE, warning=FALSE}
deptTblcut <- deptTbl[1:8]

ggplot(data=boston[!is.na(boston$GENDER),], aes(x=DEPT, fill=GENDER)) +
  geom_bar(stat="count") +
  labs(title = "City of Boston: eight most populous departments by gender") +
  labs(x="Department", y="Employee count") +
  scale_x_discrete(limits=names(deptTblcut)) + theme_minimal()

```


We can see that the police department hires the most employees by far, followed by the fire department, and then by Substitute teachers/nurses.

I would note that while substitute teachers are lumped into one department across the city, teachers are categorized into department by individual schools; so there are likely more teachers in the city than there are substitute teachers, despite current appearances.

Also note the gender distribution: police, fire, and facility departments are mostly male, while substitute teachers/nurses, special education, and Boston Public Library employees are mostly female.


``` {r echo=FALSE}
eightdept <- boston[which(boston$DEPT %in% names(deptTblcut)), ]
eightTbl <- table(droplevels(eightdept$DEPT), eightdept$GENDER);
tblchi <- chisq.test(eightTbl); tblchi
```

Running a chi-square test of independence between department and gender within our subset of eight departments results in an extremely small p-value. Hence, gender and department are not independent with respect to population, fortifying our visual observation that gender distribution is significantly inconsistent across departments.

We can repeat this, now considering total compensation summed over departments, rather than department population.


``` {r echo=FALSE, warning=FALSE}
ggplot(data=boston[!is.na(boston$GENDER),], aes(x=DEPT, y=TOTAL, fill=GENDER)) +
  geom_bar(stat="identity") +
  labs(title = "City of Boston: total compensation in eight most populous departments") +
  labs(x="Department", y="Total compensation") +
  scale_x_discrete(limits=names(deptTblcut)) + theme_minimal()

tblsum <- tapply(eightdept$TOTAL,
                 INDEX = list(droplevels(eightdept$DEPT),eightdept$GENDER), sum)
sumchi <- chisq.test(tblsum); sumchi

```


Police and Fire departments are receiving the most in total compensation, which can be attributed at least in part to their high employee counts. However, the bars representing the other six departments are visibly shorter with respect to the police and fire department bars, considering the previous graph.

Note in particular the third most populated department, "substitute teachers/nurses," who are making starkly far less in proportion to their employee count.

Again, our chi-square p-value is almost 0; gender and department are not independent with respect to total compensation. Distribution of compensation with respect to gender is significantly inconsistent across departments.

It's difficult to differentiate higher individual pay from high department population in the above graph. Do police and fire department employees actually earn more? Let's look at average compensations.

``` {r echo=FALSE}
tblAvg <- tapply(eightdept$TOTAL,
       INDEX = list(droplevels(eightdept$DEPT)), mean); sort(tblAvg, decreasing=TRUE)
```

Police and fire department employees do indeed earn the most individually, out of these eight departments.


``` {r echo=FALSE}

dfAvg <- melt(tblAvg, varnames = "DEPT", id.vars="DEPT")
ggplot(data=dfAvg, aes(x=DEPT, y=value, fill=DEPT)) +
  geom_bar(stat="identity") +
  labs(title = "City of Boston: average individual compensation by department") +
  labs(x="Department", y="Average individual compensation") +
  scale_fill_manual(values=c("lightpink", "darkorange", "skyblue", "yellow",
                             "aquamarine1", "mediumpurple1",
                             "firebrick2", "dodgerblue3")) +
  scale_x_discrete(limits=names(deptTblcut)) + theme_minimal()

avgchi <- chisq.test(tblAvg); avgchi

```

Visualizing average individual compensations makes it clear that police and fire department employees are earning much more on average; this conclusion is fortified by the results of our chi-square test. Distribution of compensation is significantly inconsistent across departments.

Finally, let's take a look at average compensation over genders in these eight departments.


``` {r echo=FALSE}
tblAvgGender <- tblsum/eightTbl
dfAvgGender <- melt(tblAvgGender, varnames = c("DEPT", "GENDER"), id.vars="DEPT")
ggplot(data=dfAvgGender, aes(x=DEPT, y=value, fill=GENDER)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "City of Boston: average individual compensation by department") +
  labs(x="Department", y="Average individual compensation") +
  scale_x_discrete(limits=names(deptTblcut)) + theme_minimal()

avgchiGender <- chisq.test(tblAvgGender); avgchiGender

```
Men are individually paid more on average in the Police, Fire, and Facility departments.
Women are individually paid more on average in the Special Education and Youth & Families departments.

Again, our chi-square p-value is almost 0; gender and department are not independent with respect to total compensation. Whether you'll make more money as a man or woman does depend significantly on department.


### Analysis by department
#### Three selected departments

Let's pick an even smaller subset of departments to inspect more closely. I went with the Boston Police Department (3149 employees), Boston Fire Department (1680 employees), and Boston Public Library (496 employees).


```{r echo=FALSE}

getdeptDF <- function(deptname){
  idx <- which(boston$DEPT == deptname)
  return(boston[idx,])}

policeBOS <- getdeptDF("Boston Police Department")
fireBOS <- getdeptDF("Boston Fire Department")
libBOS <- getdeptDF("Boston Public Library")

deptcombo <- rbind(policeBOS, fireBOS, libBOS)

ggplot(data=policeBOS, aes(TOTAL)) +
  geom_histogram(breaks=seq(0, max(policeBOS$TOTAL), by = 5000),
                 col = "blue", fill = "skyblue") +
  labs(title = "Boston Police Department: total earnings") +
  labs(x="Total earnings", y="Count") + theme_minimal()

```

The distribution of police department total earnings looks much more normal than that of all the departments together, which, if we'll recall, I speculated might follow an exponential density curve.

Considering that this department is the most populated one in our dataset, it's possible that this distribution may actually explain parts of that earlier, very irregular histogram. There's a large spike here around \$0, and I would estimate the peak of this bell curve to lie just a little bit above \$100k. It's possible that the earlier histogram would more closely follow an exponential curve without the influence of this very large department.

```{r echo=FALSE}

ggplot(data=fireBOS, aes(fireBOS$TOTAL)) +
  geom_histogram(breaks=seq(0, max(fireBOS$TOTAL), by = 5000),
                 col = "darkorange4", fill = "darkorange") +
  labs(title = "Boston Fire Department: total earnings") +
  labs(x="Total earnings", y="Count") + theme_minimal()

```

The distribution of fire department total earnings also looks quite normal. Again, it's possible that the dramatic spike here around \$100k has an influence on the irregular histogram of total compensations over all departments.


```{r echo=FALSE}

ggplot(data=libBOS, aes(libBOS$TOTAL)) +
  geom_histogram(breaks=seq(0, max(libBOS$TOTAL), by = 5000),
                 col = "darkgrey", fill = "yellow") +
  labs(title = "Boston Public Libary: total earnings") +
  labs(x="Total earnings", y="Count") + theme_minimal()


```

Library earnings also look relatively normal, though there is low-paid cluster around \$0.


```{r echo=FALSE}

ggplot(data=deptcombo, aes(x=TOTAL, fill=DEPT)) +
  geom_histogram(binwidth=10000, col="darkgrey", alpha=.7, position="identity") +
  labs(title = "BPD, BFD, and BPL: total earnings") +
  labs(x="Total earnings", y="Count") + theme_minimal() +
  scale_fill_manual(values=c("darkorange", "skyblue", "yellow"))


```

Plotting the three histograms on the same set of axes reveals that library salaries are clearly clustered towards the bottom of the earnings scale.

Police and fire department salaries look like they have roughly the same mean, but police salaries might have a higher variance.

Comparing the difference in means using a permutation test results in a p-value of less than 5%, indicating that there is a low probability of a difference in means being as high as our observed difference.

Theoretically, this indicates that police dept. and fire dept. compensations are likely not pooled from the same distribution; i.e., fire dept. employees are significantly likely to be paid more than police dept. employees.


### Teachers

We looked at some analysis over the most populous departments in the city; now let's consider teachers.

Although teachers compose a sizeable chunk of the city's employees, they don't feature prominently when sorted by department, since teachers are classified
by their individual schools. There are 5,437 teachers employed by the City of Boston, compared with 4,829 employees in the combined police and fire departments.

Of those teachers, there are almost three times as many women as there are men.

```{r echo=FALSE}
teachBOS <- boston[which(boston$TITLE == 'Teacher'),]

summary(teachBOS$TOTAL)

```

Teachers make a mean of \$78k, but a median of \$88k, suggesting a skewed distribution.

```{r echo=FALSE}

ggplot(data=teachBOS, aes(TOTAL)) +
  geom_histogram(breaks=seq(0, max(teachBOS$TOTAL), by = 5000),
                 col = "lightgoldenrod4", fill = "lightgoldenrod") +
  labs(title = "City of Boston teachers: total compensation") +
  labs(x="Total compensation", y="Count") + theme_minimal()
```

The visual confirms our suspicions: the distribution seems somewhat normal, but there is definitely a strong left skew.
And by gender:

```{r echo=FALSE}

ggplot(data=(teachBOS[!is.na(teachBOS$GENDER),]), aes(x=TOTAL, fill=GENDER)) +
  geom_histogram(binwidth=5000, col = 'black', position='identity') +
  labs(title = "Teacher total earnings by gender") +
  labs(x="Total earnings", y="Count") + theme_minimal()

```

It looks as if the distributions for male and female teachers have approximately the same shape.

Though female teachers earn an average of \$240 more than male teachers in total compensation, both a chi-square and a permutation test conclude that this difference is not significant. Female teachers are not likely to earn more on average than male teachers.

### Gender and base salary

I wanted to know: over all departments and professions, do female employees earn a larger percentage of their total earnings via a "base" salary than do male employees?


```{r echo=FALSE}
idxFem <- which(boston$GENDER == "F")
femBOS <- boston[idxFem,]

idxM <- which(boston$GENDER == "M")
maleBOS <- boston[idxM,]
percentF <- femBOS$REGULAR/femBOS$TOTAL
percentM <- maleBOS$REGULAR/maleBOS$TOTAL

```
* Average compensation is much higher for men (about \$90k) than it is for women (about \$60k).

* Correlation between regular and total compensations for women (`r round(cor(femBOS$TOTAL, femBOS$REGULAR),2)`) is closer to 1 than correlation between regular and total compensations for men  (`r round(cor(maleBOS$TOTAL, maleBOS$REGULAR),2)`). This suggests that women earn a greater proportion of their total compensation through a base salary than men do.

* My hunch is fortified by the average percentages of total compensation comprised by base salary: `r round(mean(percentF),2)*100`% amongst women and `r round(mean(percentM),2)*100`% amongst men.

We can visualize this difference using linear regression.

```{r echo=FALSE}

plot(femBOS$REGULAR,femBOS$TOTAL,cex = .5, col='red',
     main = paste("Regular vs. Total earnings amongst women"),
     xlab = "Regular earnings",
     ylab = "Total earnings")

```

```{r echo=FALSE}
plot(maleBOS$REGULAR,maleBOS$TOTAL,cex = .5, col='blue',
     main = paste("Regular vs. Total earnings amongst men"),
     xlab = "Regular earnings",
     ylab = "Total earnings")
```

As I mentioned earlier, there is a hard line on the scatterplot of regular vs. total earnings where the two variables are equal.

No points fall below this line, and points above the line indicate employees who recieve earnings outside of their regular base salary.

It looks to me like the points indicating female earnings are clustered more closely around the regular = total line, while points indicating male earnings spread further above the line.


```{r echo=FALSE}
fem.lm <- lm(femBOS$TOTAL~femBOS$REGULAR)

plot(femBOS$REGULAR,femBOS$TOTAL,cex = .2, col='lightpink',
     main = paste("Regular vs. Total earnings amongst women"),
     xlab = "Regular earnings",
     ylab = "Total earnings")
abline(fem.lm, col="red", lty = 2, lwd=3)

```

Our R-squared value for the best-fit regression line generated for female earnings is about .89, indicating that the regression line is quite well-fitted to the data.

The formula for the best fit linear regression line is total = 1.01*(regular) + 2991

This line runs almost exactly parallel to the regular = total , but our regression line has a slightly higher y-intercept.

This indicates that women who receive higher base salaries are equally as likely to receive additional compensation as those who receive lower base salaries. In addition, women are expected to receive an average of about \$3000 in addition to their base salaries.


```{r echo=FALSE}
male.lm <- lm(maleBOS$TOTAL~maleBOS$REGULAR)

plot(maleBOS$REGULAR,maleBOS$TOTAL,cex = .2, col='skyblue',
     main = paste("Regular vs. Total earnings amongst men"),
     xlab = "Regular earnings",
     ylab = "Total earnings")
abline(male.lm, col="blue", lty = 2, lwd=3)
```

Our R-squared value for the best-fit regression line generated for male earnings is about .70, which is still high, but not as well-fitted as was the regression line for women.

The formula for the best fit linear regression line is total = 1.25*(regular) + 5092

The intercept and slope are both slightly higher than are the intercept and slope on the female regression line; it's not terribly far from the regular=total line, but it certainly doesn't look parallel, as the regression line for women did.

The regression line intercept for men is not as simply interpretable as it was for women; male employees of the city who make a base salary of \$0 are expected to receive an average of about \$5000 in other compensations. This amount increases as base salary increases: men who receive higher base salaries are more likely to receive additional compensation than men who receive lower base salaries, at the rate of 1.25 dollars per every dollar increase in base salary.


```{r echo=FALSE}
plot(regular, total, type='n',
     main = paste("Regular vs. Total earnings: best-fit regression lines per gender"),
     xlab = "Regular earnings",
     ylab = "Total earnings")
abline(a = 0, b = 1, col="black", lty = 3, lwd=1)
abline(fem.lm, col="red", lty = 1, lwd=2)
abline(male.lm, col="blue", lty = 1, lwd=2)
```

Plotting both best-fit regression lines and the regular=total line on the same axes makes for a clearer visual.

We can see again that the best fit regression line for women's earnings is extremely close to
the regular=total line. This fortifies our previous conclusions that women's base salaries are likely to compose a large proportion of their total earnings.

The best fit regression line for men's earnings is farther and higher up from the x=y line, suggesting that men are more likely to recieve compensations in addition to their base salary, and furthermore that men who receive higher base salaries are more likely to recieve additional compensation than men who receive lower base salaries.



